/*
 * board.c
 *
 *  Created on: 2025年8月27日
 *      Author: jzy
 */

// --------------------------------------
// 头文件
// --------------------------------------

#include "F28x_Project.h"


// --------------------------------------
// 变量定义
// --------------------------------------



// --------------------------------------
// 函数定义
// --------------------------------------

// =============================================================================
/*******************************************************************************
 函数名称：    void InitBoard(void)
 功能描述：    板上硬件部分初始化
 输入参数：    无
 输出参数：    无
 返 回 值：    无
 其它说明：
 修改日期      版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/08/27    V1.0           JZY              创建
********************************************************************************/
/* ------------------------------------------------------------
 * 硬件部分初始化顺序
 * ------------------------------------------------------------
 * 1、GPIO 初始化
 * 2、ADC  公用初始化
 * 3、ADC A 通道初始化
 * 4、ADC B 通道初始化
 * 5、ADC C 通道初始化
 * 6、ePWM1 初始化
 * 7、ePWM2 初始化
 ------------------------------------------------------------ */
void InitBoard(void)
{
    // -------------------------------------
    // 1、GPIO 初始化
    // -------------------------------------
    InitGpio();          // 初始化所有的 GPIO
    Init_SpecialGpio();  // 初始化一些相关安全系统使用的特殊 GPIO
    Init_Led();          // LED 灯

    // -------------------------------------
    // 2、ADC 公用初始化
    // -------------------------------------
    /* --------------------------------------------------------
     * 初始化所有 ADC 的配置：参考源、时钟以及产生中断的时机
     * ------------------------------------------------------
     * 设置内部参考源 1.65V 模式 实际使用内部 ADC 参考电压为 3.3V
     * 设置分频系数 4  100M/4 = 25M  ADCCLK = 25MHz
     * ADC 转换完毕后，再产生中断
     * ADC 上电使能
     * ------------------------------------------------------*/
    Init_ADC();

    // -------------------------------------
    // 3、配置 ADC A
    // -------------------------------------
    /* ------------------------------------------------------
    * 采用过采样 SOC0 - SOC5 共 6 个SOC依次采集 ADCAIN6
    * No ADCINT will trigger SOC0 - SOC5
    * 样本保持时长 5 SYSCLK
    * 禁止  Burst Mode
    * SOC 默认优先级 从 SOC0 开始
    * 使能 ADC A 的 INT1 中断
    * ------------------------------------------------------*/
    ConfigureADCA_SOC(); // 直流电压采样

    // 配置 ADC A 后处理模块
    /* ------------------------------------------------------
    * 对 SOC4 采集的数据进行后处理校正
    * ------------------------------------------------------*/
    //ConfigureADCA_PPB1();

    // -------------------------------------
    // 4、配置 ADC B
    // -------------------------------------
    /* ------------------------------------------------------
    * 采用过采样 SOC0 - SOC4 共 5 个SOC 依次采集 ADCBIN6
    * No ADCINT will trigger SOC0 - SOC4
    * 样本保持时长 5 SYSCLK
    * 禁止  Burst Mode
    * SOC 默认优先级 从 SOC0 开始
    * 禁止 ADC 所有中断
    * ------------------------------------------------------*/
    ConfigureADCB_SOC(); // 电感电流采样

    // -------------------------------------
    // 5、配置 ADC C
    // -------------------------------------
    /* ------------------------------------------------------
    * 采用过采样 SOC0 - SOC4 共 5 个SOC 依次采集 ADCBIN6
    * No ADCINT will trigger SOC0 - SOC4
    * 样本保持时长 5 SYSCLK
    * 禁止  Burst Mode
    * SOC 默认优先级 从 SOC0 开始
    * 禁止 ADC 所有中断
    * ------------------------------------------------------*/
    ConfigureADCC_SOC(); // 交流电压采样


    // -------------------------------------
    // 6、ePWM1 配置
    // -------------------------------------
    /* ------------------------------------------------------
    * 上下计数模式 \ PWM 时钟频率 = 100M \ PWM 开关频率 = 20K
    * set duty 0% initially
    * 初始化 NO_ACTION
    * TBCTR = TBPRD 触发 SOCA 即触发 ADC 采样
    * 当计时器递减时，时基计数器等于CMPB 触发中断
    * EPWM1A EPWM1B 互补输出
    * 上升沿延时 下降沿延时 都使能 死区时间=200ns
    *
    *
    * ePWM1 为主模式
    * 当 CTR = zero 输出同步信号
    * ------------------------------------------------------*/
    Init_ePWM1();
    Init_ePWM1GPIO(); // 配置 ePWM1GPIO

    // 基本时间计数器同步
    /* ------------------------------------------------------
    ePWM模块能够自动同步到另一个ePWM模块的时间基。
    可以将超前或滞后相位控制添加到由不同的ePWM模块产生的波形中，以使其同步。
    在向上向下计数模式下，TBCTL[PSHDIR]位在同步事件后立即配置时基计数器的方向。
    新的方向与同步事件发生之前的方向无关。
    在向上计数或向下计数模式下，将忽略TBCTL[PSHDIR]位。
    * ------------------------------------------------------*/

    // -------------------------------------
    // 7、ePWM2 配置
    // -------------------------------------
    /* ------------------------------------------------------
    * 上下计数模式 \ PWM 时钟频率 = 100M \ PWM 开关频率 = 20K
    * set duty 0% initially
    * 初始化 NO_ACTION
    *
    * ePWM2 为从模式
    * 使能相位寄存器 设置相位偏移计数器为 2
    * ------------------------------------------------------*/

    Init_ePWM2();
    Init_ePWM2GPIO(); // 配置 ePWM2GPIO
}

// =============================================================================
/*******************************************************************************
 函数名称：    void InitDebug(void)
 功能描述：    调试串口的初始化
 输入参数：    无
 输出参数：    无
 返 回 值：    无
 其它说明：
 修改日期      版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/08/27    V1.0           JZY              创建
********************************************************************************/
/* ------------------------------------------------------------
 * Serial Communications Interface (SCI) 串口配置
 * 主要用于调试时，数据监控
 * ------------------------------------------------------------
 * 1、配置 SCIA GPIO
 * 2、配置 SCIA
 * 3、配置 SCIA FIFO
 * ------------------------------------------------------------ */
void InitDebug(void)
{
    // -------------------------------------
    // 1、配置 SCIA GPIO
    // -------------------------------------
    Init_SCIAGPIO(); // GPIO28 is the SCI Rx pin. GPIO29 is the SCI Tx pin.

    // -------------------------------------
    // 2、配置 SCIA
    // -------------------------------------
    /* ------------------------------------------------------
     * Open a COM port with the following settings using a terminal:
     *   -  Find correct COM port
     *   -  Bits per second = 115200
     *   -  Data Bits = 8
     *   -  Parity = None
     *   -  Stop Bits = 1
     *   -  Hardware Control = None
     *   ------------------------------------------------------*/
    Init_SCIA();

    // -------------------------------------
    // 3、配置 SCIA FIFO
    // -------------------------------------
    Init_SCIA_FIFO();
}


// =============================================================================
/*******************************************************************************
 函数名称：    void FloatToByte(float32_t floatNum,uint16_t byteArry[])
 功能描述：    a.将单精度浮点数按内存字节顺序分解为4个字节数据
              b.通过直接访问浮点数的内存表示实现转换，保持二进制数据的精确性
 输入参数：    floatNum: 要转换的单精度浮点数
 输出参数：    byteArry: 输出字节数组(必须至少能容纳4个uint16_t元素)
              存储顺序: byteArry[0]=最低位字节, byteArry[3]=最高位字节
 返 回 值：    无
 其它说明：
 修改日期      版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/08/27    V1.0           LW              创建
********************************************************************************/
void FloatToByte(float32_t floatNum,uint16_t byteArry[]){

    uint32_t longdata = 0;

    // 通过指针类型转换直接访问浮点数的二进制表示
    // 将float类型变量的地址强制转换为uint32_t指针，然后解引用获取其二进制内容
    longdata = *(uint32_t*)&floatNum;
    byteArry[3] = (longdata & 0xFF000000) >> 24;   // 提取最高位字节(位31-24): 包含符号位和指数高位
    byteArry[2] = (longdata & 0x00FF0000) >> 16;   // 提取次高位字节(位23-16): 包含指数低位和尾数高位
    byteArry[1] = (longdata & 0x0000FF00) >> 8;    // 提取次低位字节(位15-8): 尾数中位
    byteArry[0] = (longdata & 0x000000FF);         // 提取最低位字节(位7-0): 尾数低位

}



// =============================================================================
/*******************************************************************************
 函数名称：    void sendVOFAonechannel(float32_t floatNum,uint16_t byteArry[])
 功能描述：    a.将单个浮点数通过SCI串口发送至VOFA+上位机软件
              b.该函数将浮点数转换为字节数组后，按顺序通过串口发送
 输入参数：    floatNum: 待发送的浮点数数据
              byteArry: 用于存储转换后字节的数组（至少4字节长度）
 输出参数：    无
 返 回 值：    无
 其它说明：    a.需要事先初始化SCI串口模块
             b.VOFA+端需要设置为对应的数据格式（如float32）
 修改日期      版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/08/27    V1.0           LW             创建
********************************************************************************/
void sendVOFAonechannel(float32_t floatNum,uint16_t byteArry[]){

    FloatToByte(floatNum,byteArry); // 将浮点数转换为4字节数组

    transmitSCIAChar(byteArry[0]);  // 发送第1个字节（最低位）
    transmitSCIAChar(byteArry[1]);  // 发送第2个字节
    transmitSCIAChar(byteArry[2]);  // 发送第3个字节
    transmitSCIAChar(byteArry[3]);  // 发送第4个字节（最高位）
}


// =============================================================================
/*******************************************************************************
 函数名称：    void sendVOFAtail(void)
 功能描述：    a.发送VOFA+数据帧尾标志
              b.该函数发送特定的4字节序列作为数据帧的结束标记
 输入参数：    无
 输出参数：    无
 返 回 值：    无
 其它说明：    a.VOFA+是一款图形化数据分析工具
              b.数据通常以帧为单位传输，每帧数据需要特定的头尾标志
              c.此处发送的4字节序列 0x00, 0x00, 0x80, 0x7F 是VOFA+定义的帧尾标志
              d.在发送完一帧中的所有数据通道值后调用此函数，表示当前帧结束
 修改日期      版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/08/27    V1.0           LW             创建
********************************************************************************/
void sendVOFAtail(void){

    transmitSCIAChar(0x00);     // 帧尾字节1
    transmitSCIAChar(0x00);     // 帧尾字节2
    transmitSCIAChar(0x80);     // 帧尾字节3
    transmitSCIAChar(0x7F);     // 帧尾字节4
}


// ---------------------------------
// End of File
// ---------------------------------

